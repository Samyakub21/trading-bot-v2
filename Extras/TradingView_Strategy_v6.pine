// This source code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © YourTradingBot

//@version=6
strategy("Trading Bot Signal Strategy", overlay=true, initial_capital=50000, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

// ============================================================================
// INPUT PARAMETERS
// ============================================================================
// Risk Management
maxDailyLoss = input.int(5000, "Max Daily Loss (₹)", group="Risk Management")
maxTradesPerDay = input.int(5, "Max Trades Per Day", group="Risk Management")

// Signal Thresholds
rsiBullishThreshold = input.int(60, "RSI Bullish Threshold", minval=50, maxval=70, group="Signal Settings")
rsiBearishThreshold = input.int(40, "RSI Bearish Threshold", minval=30, maxval=50, group="Signal Settings")
volumeMultiplier = input.float(1.2, "Volume Multiplier", minval=1.0, maxval=3.0, step=0.1, group="Signal Settings")

// Indicator Lengths
ema50Length = input.int(50, "EMA Length (60min)", minval=20, maxval=200, group="Indicator Settings")
rsiLength = input.int(14, "RSI Length (15min)", minval=5, maxval=30, group="Indicator Settings")
vwapAnchor = input.string("Day", "VWAP Anchor", options=["Day", "Week", "Month"], group="Indicator Settings")

// Stop Loss
slBuffer = input.int(2, "SL Buffer Points", minval=1, maxval=10, group="Stop Loss")

// Display Options
showSignals = input.bool(true, "Show Buy/Sell Signals", group="Display")
showEMA = input.bool(true, "Show EMA (Trend)", group="Display")
showVWAP = input.bool(true, "Show VWAP", group="Display")

// ============================================================================
// TIMEFRAME DETECTION
// ============================================================================
is15min = timeframe.period == "15"
is60min = timeframe.period == "60"

// ============================================================================
// TECHNICAL INDICATORS
// ============================================================================

// === 60-MINUTE TREND (EMA 50) ===
// For lower timeframes, request 60min data
ema50_value = is60min ? ta.ema(close, ema50Length) : request.security(syminfo.tickerid, "60", ta.ema(close, ema50Length), lookahead=barmerge.lookahead_off)

// === 15-MINUTE SIGNALS ===
// VWAP - Daily anchor by default
vwap_value = ta.vwap(hlc3)

// RSI
rsi = ta.rsi(close, rsiLength)

// Volume Average
volAvg = ta.sma(volume, 20)

// ============================================================================
// SIGNAL LOGIC
// ============================================================================

// Volume Confirmation
volumeConfirmed = volume >= (volAvg * volumeMultiplier)

// BULLISH SIGNAL CONDITIONS:
// 1. Trend: Close > EMA50 (60min)
// 2. Trigger: Close > VWAP (15min)
// 3. RSI > Bullish Threshold (15min)
// 4. Volume Confirmed
bullishTrendCondition = close > ema50_value
bullishTriggerCondition = close > vwap_value
bullishRSICondition = rsi > rsiBullishThreshold

bullishSignal = bullishTrendCondition and bullishTriggerCondition and bullishRSICondition and volumeConfirmed

// BEARISH SIGNAL CONDITIONS:
// 1. Trend: Close < EMA50 (60min)
// 2. Trigger: Close < VWAP (15min)
// 3. RSI < Bearish Threshold (15min)
// 4. Volume Confirmed
bearishTrendCondition = close < ema50_value
bearishTriggerCondition = close < vwap_value
bearishRSICondition = rsi < rsiBearishThreshold

bearishSignal = bearishTrendCondition and bearishTriggerCondition and bearishRSICondition and volumeConfirmed

// ============================================================================
// DYNAMIC STOP LOSS CALCULATION
// ============================================================================

// Function to calculate dynamic SL based on swing points
f_getDynamicSL(isBuy, buffer) =>
    var float slPrice = na
    
    if isBuy
        // For buy: Use swing low of last 2 bars minus buffer
        swingLow = ta.lowest(low[1], 2)
        slPrice := swingLow - buffer
        
        // Minimum SL distance check (5 points)
        if (close - slPrice) < 5
            slPrice := close - 10
    else
        // For sell: Use swing high of last 2 bars plus buffer
        swingHigh = ta.highest(high[1], 2)
        slPrice := swingHigh + buffer
        
        // Minimum SL distance check (5 points)
        if (slPrice - close) < 5
            slPrice := close + 10
    
    slPrice

// ============================================================================
// STEP LADDER TRAILING (R-MULTIPLE BASED)
// ============================================================================

var float entryPrice = na
var float initialSL = na
var float currentSL = na
var int stepLevel = 0

// Calculate risk unit (R)
riskUnit = math.abs(entryPrice - initialSL)

// Current profit in R-multiples
currentR = strategy.position_size > 0 ? (close - entryPrice) / riskUnit : 
           strategy.position_size < 0 ? (entryPrice - close) / riskUnit : 0.0

// Update trailing stops based on R-multiples
if strategy.position_size != 0
    // Step 1: Lock 1R profit when 2R reached
    if currentR >= 2.0 and stepLevel < 2
        stepLevel := 2
        currentSL := strategy.position_size > 0 ? entryPrice + (1.0 * riskUnit) : entryPrice - (1.0 * riskUnit)
        strategy.exit("Step1", stop=currentSL)
        
    // Step 2: Lock 2R profit when 3R reached
    else if currentR >= 3.0 and stepLevel < 3
        stepLevel := 3
        currentSL := strategy.position_size > 0 ? entryPrice + (2.0 * riskUnit) : entryPrice - (2.0 * riskUnit)
        strategy.exit("Step2", stop=currentSL)
        
    // Step 3: Lock 3R profit when 4R reached
    else if currentR >= 4.0 and stepLevel < 4
        stepLevel := 4
        currentSL := strategy.position_size > 0 ? entryPrice + (3.0 * riskUnit) : entryPrice - (3.0 * riskUnit)
        strategy.exit("Step3", stop=currentSL)

// ============================================================================
// STRATEGY EXECUTION
// ============================================================================

// Entry Conditions - only on 15min timeframe or if you're on 1min/5min
if is15min or timeframe.in_seconds(timeframe.period) < 900 // 900 seconds = 15 minutes

    // LONG ENTRY (CALL)
    if bullishSignal and strategy.position_size == 0
        entryPrice := close
        initialSL := f_getDynamicSL(true, slBuffer)
        currentSL := initialSL
        stepLevel := 0
        
        strategy.entry("CALL", strategy.long, comment="CALL Entry")
        strategy.exit("Initial SL", "CALL", stop=initialSL, limit=entryPrice + (5 * riskUnit))

    // SHORT ENTRY (PUT)
    if bearishSignal and strategy.position_size == 0
        entryPrice := close
        initialSL := f_getDynamicSL(false, slBuffer)
        currentSL := initialSL
        stepLevel := 0
        
        strategy.entry("PUT", strategy.short, comment="PUT Entry")
        strategy.exit("Initial SL", "PUT", stop=initialSL, limit=entryPrice - (5 * riskUnit))

// Jackpot Exit (1:5 target)
if math.abs(currentR) >= 5.0
    strategy.close_all(comment="1:5 Target Hit")
    entryPrice := na
    initialSL := na
    currentSL := na
    stepLevel := 0

// ============================================================================
// VISUAL ELEMENTS
// ============================================================================

// Plot EMA (Trend Line)
plot(showEMA ? ema50_value : na, "EMA 50 (60min)", color=color.orange, linewidth=2)

// Plot VWAP
plot(showVWAP ? vwap_value : na, "VWAP", color=color.blue, linewidth=2)

// Plot Buy/Sell Signals
plotshape(showSignals and bullishSignal, "Buy Signal", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.small)
plotshape(showSignals and bearishSignal, "Sell Signal", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.small)

// Plot Entry Price Line
plot(strategy.position_size != 0 ? entryPrice : na, "Entry Price", color=color.white, linewidth=1, style=plot.style_linebr)

// Plot Initial SL
plot(strategy.position_size != 0 ? initialSL : na, "Initial SL", color=color.red, linewidth=1, style=plot.style_cross)

// Plot Current/Trailing SL
plot(strategy.position_size != 0 and currentSL != initialSL ? currentSL : na, "Trailing SL", color=color.yellow, linewidth=2, style=plot.style_cross)

// ============================================================================
// INFORMATION TABLE
// ============================================================================

var table infoTable = table.new(position.top_right, 2, 8, bgcolor=color.new(color.black, 85), border_width=2, border_color=color.gray)

if barstate.islast
    // Header
    table.cell(infoTable, 0, 0, "Metric", text_color=color.white, bgcolor=color.new(color.gray, 70))
    table.cell(infoTable, 1, 0, "Value", text_color=color.white, bgcolor=color.new(color.gray, 70))
    
    // RSI
    rsiColor = rsi > rsiBullishThreshold ? color.green : rsi < rsiBearishThreshold ? color.red : color.gray
    table.cell(infoTable, 0, 1, "RSI", text_color=color.white)
    table.cell(infoTable, 1, 1, str.tostring(rsi, "#.##"), text_color=rsiColor)
    
    // Volume vs Avg
    volRatio = volAvg > 0 ? volume / volAvg : 1.0
    volColor = volRatio >= volumeMultiplier ? color.green : color.gray
    table.cell(infoTable, 0, 2, "Vol/Avg", text_color=color.white)
    table.cell(infoTable, 1, 2, str.tostring(volRatio, "#.##") + "x", text_color=volColor)
    
    // Trend Status
    trendText = close > ema50_value ? "BULLISH" : close < ema50_value ? "BEARISH" : "NEUTRAL"
    trendColor = close > ema50_value ? color.green : close < ema50_value ? color.red : color.gray
    table.cell(infoTable, 0, 3, "Trend", text_color=color.white)
    table.cell(infoTable, 1, 3, trendText, text_color=trendColor)
    
    // VWAP Status
    vwapText = close > vwap_value ? "ABOVE" : "BELOW"
    vwapColor = close > vwap_value ? color.green : color.red
    table.cell(infoTable, 0, 4, "VWAP", text_color=color.white)
    table.cell(infoTable, 1, 4, vwapText, text_color=vwapColor)
    
    // Position Status
    posText = strategy.position_size > 0 ? "LONG (CALL)" : strategy.position_size < 0 ? "SHORT (PUT)" : "FLAT"
    posColor = strategy.position_size > 0 ? color.green : strategy.position_size < 0 ? color.red : color.gray
    table.cell(infoTable, 0, 5, "Position", text_color=color.white)
    table.cell(infoTable, 1, 5, posText, text_color=posColor)
    
    // R-Multiple
    if strategy.position_size != 0
        rText = str.tostring(currentR, "#.##") + "R"
        rColor = currentR > 0 ? color.green : color.red
        table.cell(infoTable, 0, 6, "Current R", text_color=color.white)
        table.cell(infoTable, 1, 6, rText, text_color=rColor)
        
        // Step Level
        stepText = "Step " + str.tostring(stepLevel)
        table.cell(infoTable, 0, 7, "Trail Level", text_color=color.white)
        table.cell(infoTable, 1, 7, stepText, text_color=color.yellow)
    else
        table.cell(infoTable, 0, 6, "", text_color=color.white)
        table.cell(infoTable, 1, 6, "", text_color=color.white)
        table.cell(infoTable, 0, 7, "", text_color=color.white)
        table.cell(infoTable, 1, 7, "", text_color=color.white)

// ============================================================================
// BACKGROUND COLORING (OPTIONAL)
// ============================================================================
// Uncomment below to add background colors for signal zones

// bullishZone = bullishTrendCondition and bullishTriggerCondition and bullishRSICondition
// bearishZone = bearishTrendCondition and bearishTriggerCondition and bearishRSICondition

// bgcolor(bullishZone ? color.new(color.green, 95) : na)
// bgcolor(bearishZone ? color.new(color.red, 95) : na)

// ============================================================================
// ALERTS
// ============================================================================

// Alert conditions for automated trading
alertcondition(bullishSignal, "Bullish Signal", "CALL Entry Signal Triggered!")
alertcondition(bearishSignal, "Bearish Signal", "PUT Entry Signal Triggered!")
alertcondition(currentR >= 2.0 and stepLevel == 2, "Step 1 Reached", "Locked 1R Profit (Step 1)")
alertcondition(currentR >= 3.0 and stepLevel == 3, "Step 2 Reached", "Locked 2R Profit (Step 2)")
alertcondition(currentR >= 4.0 and stepLevel == 4, "Step 3 Reached", "Locked 3R Profit (Step 3)")
alertcondition(currentR >= 5.0, "Jackpot Target", "1:5 Target Hit - Jackpot Exit!")

// ============================================================================
// NOTES
// ============================================================================
// This Pine Script replicates the trading bot logic:
// 
// BULLISH SIGNAL (CALL):
// - 60min: Close > EMA50 (Trend confirmation)
// - 15min: Close > VWAP (Trigger)
// - 15min: RSI > 60 (Momentum confirmation)
// - Volume > 1.2x Average (Volume confirmation)
//
// BEARISH SIGNAL (PUT):
// - 60min: Close < EMA50 (Trend confirmation)
// - 15min: Close < VWAP (Trigger)
// - 15min: RSI < 40 (Momentum confirmation)
// - Volume > 1.2x Average (Volume confirmation)
//
// RISK MANAGEMENT:
// - Dynamic SL based on swing high/low
// - Step Ladder Trailing:
//   * 1:2 → Lock 1R profit
//   * 1:3 → Lock 2R profit
//   * 1:4 → Lock 3R profit
//   * 1:5 → Full exit (Jackpot)
//
// USAGE:
// 1. Apply to 15-minute chart (or 1min/5min for faster signals)
// 2. Works on Futures, Commodities, Indices
// 3. Adjust RSI thresholds and volume multiplier per instrument
// 4. Use Strategy Tester for backtesting
// 5. Set up alerts for live trading signals
// ============================================================================
